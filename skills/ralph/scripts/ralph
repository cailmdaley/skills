#!/bin/bash
# Run a ralph loop on a spec file
# Loops while spec status is open/active, appending spec content to system prompt
# Usage: ralph <spec.md> [-- extra-claude-flags...]

set -e

SPEC_FILE="${1:?Usage: ralph <spec.md> [-- extra-claude-flags...]}"
shift

EXTRA_FLAGS=""
if [[ "$1" == "--" ]]; then
    shift
    EXTRA_FLAGS="$*"
fi

# Resolve to absolute path
SPEC_FILE="$(cd "$(dirname "$SPEC_FILE")" && pwd)/$(basename "$SPEC_FILE")"

if [[ ! -f "$SPEC_FILE" ]]; then
    echo "Spec file not found: $SPEC_FILE"
    exit 1
fi

SESSION="ralph-$(basename "$SPEC_FILE" .md)"
WORK_DIR="$(pwd)"

# Check if already running
if tmux has-session -t "$SESSION" 2>/dev/null; then
    echo "Ralph already running: $SESSION"
    echo "  Attach: tmux attach -t $SESSION"
    exit 0
fi

echo "Starting ralph on $SPEC_FILE"
echo "  Work dir: $WORK_DIR"
[[ -n "$EXTRA_FLAGS" ]] && echo "  Flags:    $EXTRA_FLAGS"

# Create tmux session with the ralph loop
tmux new-session -d -s "$SESSION" -c "$WORK_DIR" bash -c "
    iteration=0

    # Check YAML frontmatter for status field
    check_status() {
        head -50 '$SPEC_FILE' | sed -n '/^---$/,/^---$/p' | grep -qiE 'status:.*(open|active)'
    }

    while check_status; do
        iteration=\$((iteration + 1))
        echo ''
        echo '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━'
        echo \"Ralph iteration \$iteration — \$(date '+%H:%M:%S')\"
        echo '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━'

        SPEC_CONTENT=\$(cat '$SPEC_FILE')
        SYSTEM_PROMPT=\"Ralph iteration \$iteration. Spec: $SPEC_FILE

\$SPEC_CONTENT\"
        echo \"You are inside a Ralph loop — a meditative iteration toward a desired state. Activate the Ralph skill and follow its instructions for iterating on the spec above.\" | claude --dangerously-skip-permissions $EXTRA_FLAGS --append-system-prompt \"\$SYSTEM_PROMPT\"

        echo '--- Iteration complete ---'
        sleep 2
    done

    echo ''
    echo '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━'
    echo \"Ralph complete — \$iteration iterations\"
    echo '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━'
    echo ''
    echo 'Session kept open for inspection. Type exit to close.'
    exec bash
"

echo "  Session:  $SESSION"
echo "  Attach:   tmux attach -t $SESSION"
